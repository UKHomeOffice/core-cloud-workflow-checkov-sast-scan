{"$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/main/sarif-2.1/schema/sarif-schema-2.1.0.json", "version": "2.1.0", "runs": [{"tool": {"driver": {"name": "Checkov", "version": "3.2.500", "informationUri": "https://checkov.io", "rules": [{"id": "CKV_AWS_382", "name": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1", "shortDescription": {"text": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1"}, "fullDescription": {"text": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1"}, "help": {"text": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1\nResource: aws_security_group.mq_broker_sg[0]"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-networking-policies/bc-aws-382"}, {"id": "CKV_AWS_209", "name": "Ensure MQ broker encrypted by KMS using a customer managed Key (CMK)", "shortDescription": {"text": "Ensure MQ broker encrypted by KMS using a customer managed Key (CMK)"}, "fullDescription": {"text": "Ensure MQ broker encrypted by KMS using a customer managed Key (CMK)"}, "help": {"text": "Ensure MQ broker encrypted by KMS using a customer managed Key (CMK)\nResource: aws_mq_broker.mq_broker"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-aws-mqbroker-is-encrypted-by-key-management-service-kms-using-a-customer-managed-key-cmk"}, {"id": "CKV_AWS_197", "name": "Ensure MQ Broker Audit logging is enabled", "shortDescription": {"text": "Ensure MQ Broker Audit logging is enabled"}, "fullDescription": {"text": "Ensure MQ Broker Audit logging is enabled"}, "help": {"text": "Ensure MQ Broker Audit logging is enabled\nResource: aws_mq_broker.mq_broker"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-aws-mqbroker-audit-logging-is-enabled"}, {"id": "CKV_AWS_149", "name": "Ensure that Secrets Manager secret is encrypted using KMS CMK", "shortDescription": {"text": "Ensure that Secrets Manager secret is encrypted using KMS CMK"}, "fullDescription": {"text": "Ensure that Secrets Manager secret is encrypted using KMS CMK"}, "help": {"text": "Ensure that Secrets Manager secret is encrypted using KMS CMK\nResource: aws_secretsmanager_secret.rds_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-that-secrets-manager-secret-is-encrypted-using-kms"}, {"id": "CKV_AWS_23", "name": "Ensure every security group and rule has a description", "shortDescription": {"text": "Ensure every security group and rule has a description"}, "fullDescription": {"text": "Ensure every security group and rule has a description"}, "help": {"text": "Ensure every security group and rule has a description\nResource: aws_security_group.this"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-networking-policies/networking-31"}, {"id": "CKV_AWS_226", "name": "Ensure DB instance gets all minor upgrades automatically", "shortDescription": {"text": "Ensure DB instance gets all minor upgrades automatically"}, "fullDescription": {"text": "Ensure DB instance gets all minor upgrades automatically"}, "help": {"text": "Ensure DB instance gets all minor upgrades automatically\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-aws-db-instance-gets-all-minor-upgrades-automatically"}, {"id": "CKV_AWS_133", "name": "Ensure that RDS instances has backup policy", "shortDescription": {"text": "Ensure that RDS instances has backup policy"}, "fullDescription": {"text": "Ensure that RDS instances has backup policy"}, "help": {"text": "Ensure that RDS instances has backup policy\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-that-rds-instances-have-backup-policy"}, {"id": "CKV_AWS_157", "name": "Ensure that RDS instances have Multi-AZ enabled", "shortDescription": {"text": "Ensure that RDS instances have Multi-AZ enabled"}, "fullDescription": {"text": "Ensure that RDS instances have Multi-AZ enabled"}, "help": {"text": "Ensure that RDS instances have Multi-AZ enabled\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/general-73"}, {"id": "CKV_AWS_118", "name": "Ensure that enhanced monitoring is enabled for Amazon RDS instances", "shortDescription": {"text": "Ensure that enhanced monitoring is enabled for Amazon RDS instances"}, "fullDescription": {"text": "Ensure that enhanced monitoring is enabled for Amazon RDS instances"}, "help": {"text": "Ensure that enhanced monitoring is enabled for Amazon RDS instances\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/ensure-that-enhanced-monitoring-is-enabled-for-amazon-rds-instances"}, {"id": "CKV_AWS_353", "name": "Ensure that RDS instances have performance insights enabled", "shortDescription": {"text": "Ensure that RDS instances have performance insights enabled"}, "fullDescription": {"text": "Ensure that RDS instances have performance insights enabled"}, "help": {"text": "Ensure that RDS instances have performance insights enabled\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/bc-aws-353"}, {"id": "CKV_AWS_293", "name": "Ensure that AWS database instances have deletion protection enabled", "shortDescription": {"text": "Ensure that AWS database instances have deletion protection enabled"}, "fullDescription": {"text": "Ensure that AWS database instances have deletion protection enabled"}, "help": {"text": "Ensure that AWS database instances have deletion protection enabled\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/bc-aws-293"}, {"id": "CKV_AWS_16", "name": "Ensure all data stored in the RDS is securely encrypted at rest", "shortDescription": {"text": "Ensure all data stored in the RDS is securely encrypted at rest"}, "fullDescription": {"text": "Ensure all data stored in the RDS is securely encrypted at rest"}, "help": {"text": "Ensure all data stored in the RDS is securely encrypted at rest\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/general-4"}, {"id": "CKV_AWS_7", "name": "Ensure rotation for customer created CMKs is enabled", "shortDescription": {"text": "Ensure rotation for customer created CMKs is enabled"}, "fullDescription": {"text": "Ensure rotation for customer created CMKs is enabled"}, "help": {"text": "Ensure rotation for customer created CMKs is enabled\nResource: aws_kms_key.s3"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/logging-8"}, {"id": "CKV2_AWS_60", "name": "Ensure RDS instance with copy tags to snapshots is enabled", "shortDescription": {"text": "Ensure RDS instance with copy tags to snapshots is enabled"}, "fullDescription": {"text": "Ensure RDS instance with copy tags to snapshots is enabled"}, "help": {"text": "Ensure RDS instance with copy tags to snapshots is enabled\nResource: aws_db_instance.managed_password"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/bc-aws-2-60"}, {"id": "CKV2_AWS_64", "name": "Ensure KMS key Policy is defined", "shortDescription": {"text": "Ensure KMS key Policy is defined"}, "fullDescription": {"text": "Ensure KMS key Policy is defined"}, "help": {"text": "Ensure KMS key Policy is defined\nResource: aws_kms_key.s3"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-iam-policies/bc-aws-2-64"}, {"id": "CKV2_AWS_57", "name": "Ensure Secrets Manager secrets should have automatic rotation enabled", "shortDescription": {"text": "Ensure Secrets Manager secrets should have automatic rotation enabled"}, "fullDescription": {"text": "Ensure Secrets Manager secrets should have automatic rotation enabled"}, "help": {"text": "Ensure Secrets Manager secrets should have automatic rotation enabled\nResource: aws_secretsmanager_secret.mq_broker_password_secret"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/bc-aws-2-57"}, {"id": "CKV2_AWS_62", "name": "Ensure S3 buckets should have event notifications enabled", "shortDescription": {"text": "Ensure S3 buckets should have event notifications enabled"}, "fullDescription": {"text": "Ensure S3 buckets should have event notifications enabled"}, "help": {"text": "Ensure S3 buckets should have event notifications enabled\nResource: aws_s3_bucket.this"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/bc-aws-2-62"}, {"id": "CKV2_AWS_5", "name": "Ensure that Security Groups are attached to another resource", "shortDescription": {"text": "Ensure that Security Groups are attached to another resource"}, "fullDescription": {"text": "Ensure that Security Groups are attached to another resource"}, "help": {"text": "Ensure that Security Groups are attached to another resource\nResource: aws_security_group.mq_broker_sg[0]"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-networking-policies/ensure-that-security-groups-are-attached-to-ec2-instances-or-elastic-network-interfaces-enis"}, {"id": "CKV2_AWS_61", "name": "Ensure that an S3 bucket has a lifecycle configuration", "shortDescription": {"text": "Ensure that an S3 bucket has a lifecycle configuration"}, "fullDescription": {"text": "Ensure that an S3 bucket has a lifecycle configuration"}, "help": {"text": "Ensure that an S3 bucket has a lifecycle configuration\nResource: aws_s3_bucket.this"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-logging-policies/bc-aws-2-61"}, {"id": "CKV_AWS_144", "name": "Ensure that S3 bucket has cross-region replication enabled", "shortDescription": {"text": "Ensure that S3 bucket has cross-region replication enabled"}, "fullDescription": {"text": "Ensure that S3 bucket has cross-region replication enabled"}, "help": {"text": "Ensure that S3 bucket has cross-region replication enabled\nResource: aws_s3_bucket.this"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/aws-general-policies/ensure-that-s3-bucket-has-cross-region-replication-enabled"}, {"id": "CKV_AWS_18", "name": "Ensure the S3 bucket has access logging enabled", "shortDescription": {"text": "Ensure the S3 bucket has access logging enabled"}, "fullDescription": {"text": "Ensure the S3 bucket has access logging enabled"}, "help": {"text": "Ensure the S3 bucket has access logging enabled\nResource: aws_s3_bucket.this"}, "defaultConfiguration": {"level": "error"}, "helpUri": "https://docs.prismacloud.io/en/enterprise-edition/policy-reference/aws-policies/s3-policies/s3-13-enable-logging"}, {"id": "CCL_COSMOS_FINOPS_TAGS", "name": "Ensure resources have required tag associated for Costing", "shortDescription": {"text": "Ensure resources have required tag associated for Costing"}, "fullDescription": {"text": "Ensure resources have required tag associated for Costing"}, "help": {"text": "Ensure resources have required tag associated for Costing\nResource: aws_secretsmanager_secret.mq_broker_password_secret"}, "defaultConfiguration": {"level": "error"}, "properties": {"security-severity": "8.9"}}], "organization": "bridgecrew"}}, "results": [{"ruleId": "CKV_AWS_382", "ruleIndex": 0, "level": "error", "attachments": [], "message": {"text": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 58, "endLine": 114, "snippet": {"text": "resource \"aws_security_group\" \"mq_broker_sg\" {\n  count = var.create_security_group ? 1 : 0\n\n  name        = \"${var.broker_name}-sg\"\n  description = \"Security group for MQ broker ${var.broker_name}\"\n  vpc_id      = var.vpc_id\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n\n  # Ingress rules for ActiveMQ Web Console (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"ActiveMQ\" && var.publicly_accessible ? [local.activemq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow ActiveMQ Web Console (HTTPS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Broker Port (AMQPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" ? [local.rabbitmq_ports.broker_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_broker_cidrs\n      description = \"Allow RabbitMQ AMQP (SSL/TLS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Management UI (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" && var.publicly_accessible ? [local.rabbitmq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow RabbitMQ Management UI (HTTPS)\"\n    }\n  }\n\n  # Default Egress Rule (Allow all outbound)\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n    description = \"Allow all outbound traffic\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_209", "ruleIndex": 1, "level": "error", "attachments": [], "message": {"text": "Ensure MQ broker encrypted by KMS using a customer managed Key (CMK)"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 116, "endLine": 158, "snippet": {"text": "resource \"aws_mq_broker\" \"mq_broker\" {\n  broker_name                = var.broker_name\n  engine_type                = var.engine_type\n  engine_version             = var.engine_version\n  host_instance_type         = var.host_instance_type\n  deployment_mode            = var.deployment_mode\n  publicly_accessible        = var.publicly_accessible\n  auto_minor_version_upgrade = var.auto_minor_version_upgrade\n\n  # User credentials for the broker\n  user {\n    username = var.broker_username\n    password = local.final_broker_password\n  }\n\n  subnet_ids = var.subnet_ids\n  security_groups = local.final_security_group_ids\n\n\n  # Maintenance window start time (UTC)\n  maintenance_window_start_time {\n    day_of_week = var.maintenance_day_of_week # e.g., MONDAY\n    time_of_day = var.maintenance_time_of_day # e.g., 03:00\n    time_zone   = var.maintenance_time_zone   # e.g., UTC\n  }\n\n  # Enable CloudWatch Logs. Options: \"AUDIT\", \"GENERAL\"\n  logs {\n    general = var.enable_general_logs\n    audit   = var.enable_audit_logs\n  }\n\n  apply_immediately = var.apply_immediately\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n  \n  lifecycle {\n    ignore_changes = [engine_version]\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_197", "ruleIndex": 2, "level": "error", "attachments": [], "message": {"text": "Ensure MQ Broker Audit logging is enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 116, "endLine": 158, "snippet": {"text": "resource \"aws_mq_broker\" \"mq_broker\" {\n  broker_name                = var.broker_name\n  engine_type                = var.engine_type\n  engine_version             = var.engine_version\n  host_instance_type         = var.host_instance_type\n  deployment_mode            = var.deployment_mode\n  publicly_accessible        = var.publicly_accessible\n  auto_minor_version_upgrade = var.auto_minor_version_upgrade\n\n  # User credentials for the broker\n  user {\n    username = var.broker_username\n    password = local.final_broker_password\n  }\n\n  subnet_ids = var.subnet_ids\n  security_groups = local.final_security_group_ids\n\n\n  # Maintenance window start time (UTC)\n  maintenance_window_start_time {\n    day_of_week = var.maintenance_day_of_week # e.g., MONDAY\n    time_of_day = var.maintenance_time_of_day # e.g., 03:00\n    time_zone   = var.maintenance_time_zone   # e.g., UTC\n  }\n\n  # Enable CloudWatch Logs. Options: \"AUDIT\", \"GENERAL\"\n  logs {\n    general = var.enable_general_logs\n    audit   = var.enable_audit_logs\n  }\n\n  apply_immediately = var.apply_immediately\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n  \n  lifecycle {\n    ignore_changes = [engine_version]\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_149", "ruleIndex": 3, "level": "error", "attachments": [], "message": {"text": "Ensure that Secrets Manager secret is encrypted using KMS CMK"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 29, "endLine": 33, "snippet": {"text": "resource \"aws_secretsmanager_secret\" \"rds_password\" {\n  for_each   = random_password.rds\n  name       = \"${each.key}-rds-password\"\n  description = \"RDS master password for ${each.key}\"\n}\n"}}}}]}, {"ruleId": "CKV_AWS_23", "ruleIndex": 4, "level": "error", "attachments": [], "message": {"text": "Ensure every security group and rule has a description"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 41, "endLine": 65, "snippet": {"text": "resource \"aws_security_group\" \"this\" {\n  for_each    = var.security_group_ids == null ? var.instances : {}\n  name        = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  description = \"Security group for ${each.key} RDS instance\"\n  vpc_id      = var.vpc_id\n\n  ingress {\n    # Dynamically look up the port based on the instance's engine type\n    from_port   = lookup(local.engine_ports, each.value.engine, 0)\n    to_port     = lookup(local.engine_ports, each.value.engine, 0)\n    protocol    = \"tcp\"\n    cidr_blocks = each.value.allowed_cidr_blocks\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = merge(var.tags, {\n    Name = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  })\n}\n"}}}}]}, {"ruleId": "CKV_AWS_382", "ruleIndex": 0, "level": "error", "attachments": [], "message": {"text": "Ensure no security groups allow egress from 0.0.0.0:0 to port -1"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 41, "endLine": 65, "snippet": {"text": "resource \"aws_security_group\" \"this\" {\n  for_each    = var.security_group_ids == null ? var.instances : {}\n  name        = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  description = \"Security group for ${each.key} RDS instance\"\n  vpc_id      = var.vpc_id\n\n  ingress {\n    # Dynamically look up the port based on the instance's engine type\n    from_port   = lookup(local.engine_ports, each.value.engine, 0)\n    to_port     = lookup(local.engine_ports, each.value.engine, 0)\n    protocol    = \"tcp\"\n    cidr_blocks = each.value.allowed_cidr_blocks\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = merge(var.tags, {\n    Name = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  })\n}\n"}}}}]}, {"ruleId": "CKV_AWS_226", "ruleIndex": 5, "level": "error", "attachments": [], "message": {"text": "Ensure DB instance gets all minor upgrades automatically"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_133", "ruleIndex": 6, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances has backup policy"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_157", "ruleIndex": 7, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances have Multi-AZ enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_118", "ruleIndex": 8, "level": "error", "attachments": [], "message": {"text": "Ensure that enhanced monitoring is enabled for Amazon RDS instances"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_353", "ruleIndex": 9, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances have performance insights enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_293", "ruleIndex": 10, "level": "error", "attachments": [], "message": {"text": "Ensure that AWS database instances have deletion protection enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_16", "ruleIndex": 11, "level": "error", "attachments": [], "message": {"text": "Ensure all data stored in the RDS is securely encrypted at rest"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_226", "ruleIndex": 5, "level": "error", "attachments": [], "message": {"text": "Ensure DB instance gets all minor upgrades automatically"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_133", "ruleIndex": 6, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances has backup policy"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_157", "ruleIndex": 7, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances have Multi-AZ enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_118", "ruleIndex": 8, "level": "error", "attachments": [], "message": {"text": "Ensure that enhanced monitoring is enabled for Amazon RDS instances"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_353", "ruleIndex": 9, "level": "error", "attachments": [], "message": {"text": "Ensure that RDS instances have performance insights enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_293", "ruleIndex": 10, "level": "error", "attachments": [], "message": {"text": "Ensure that AWS database instances have deletion protection enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_16", "ruleIndex": 11, "level": "error", "attachments": [], "message": {"text": "Ensure all data stored in the RDS is securely encrypted at rest"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV_AWS_7", "ruleIndex": 12, "level": "error", "attachments": [], "message": {"text": "Ensure rotation for customer created CMKs is enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 1, "endLine": 7, "snippet": {"text": "resource \"aws_kms_key\" \"s3\" {\n  description             = \"KMS key for S3 bucket encryption\"\n  deletion_window_in_days = 7\n  enable_key_rotation     = false\n\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_60", "ruleIndex": 13, "level": "error", "attachments": [], "message": {"text": "Ensure RDS instance with copy tags to snapshots is enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_60", "ruleIndex": 13, "level": "error", "attachments": [], "message": {"text": "Ensure RDS instance with copy tags to snapshots is enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_64", "ruleIndex": 14, "level": "error", "attachments": [], "message": {"text": "Ensure KMS key Policy is defined"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 1, "endLine": 7, "snippet": {"text": "resource \"aws_kms_key\" \"s3\" {\n  description             = \"KMS key for S3 bucket encryption\"\n  deletion_window_in_days = 7\n  enable_key_rotation     = false\n\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_57", "ruleIndex": 15, "level": "error", "attachments": [], "message": {"text": "Ensure Secrets Manager secrets should have automatic rotation enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 41, "endLine": 51, "snippet": {"text": "resource \"aws_secretsmanager_secret\" \"mq_broker_password_secret\" {\n  name                    = local.secret_name\n  description             = \"${var.secret_description} for ${var.broker_name}\"\n  kms_key_id              = var.secret_kms_key_id\n  recovery_window_in_days = var.secret_recovery_window_in_days\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_57", "ruleIndex": 15, "level": "error", "attachments": [], "message": {"text": "Ensure Secrets Manager secrets should have automatic rotation enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 29, "endLine": 33, "snippet": {"text": "resource \"aws_secretsmanager_secret\" \"rds_password\" {\n  for_each   = random_password.rds\n  name       = \"${each.key}-rds-password\"\n  description = \"RDS master password for ${each.key}\"\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_62", "ruleIndex": 16, "level": "error", "attachments": [], "message": {"text": "Ensure S3 buckets should have event notifications enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 14, "endLine": 17, "snippet": {"text": "resource \"aws_s3_bucket\" \"this\" {\n  bucket = \"${var.project_name}-${var.bucket_name}-${var.environment}-s3\"\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_5", "ruleIndex": 17, "level": "error", "attachments": [], "message": {"text": "Ensure that Security Groups are attached to another resource"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 58, "endLine": 114, "snippet": {"text": "resource \"aws_security_group\" \"mq_broker_sg\" {\n  count = var.create_security_group ? 1 : 0\n\n  name        = \"${var.broker_name}-sg\"\n  description = \"Security group for MQ broker ${var.broker_name}\"\n  vpc_id      = var.vpc_id\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n\n  # Ingress rules for ActiveMQ Web Console (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"ActiveMQ\" && var.publicly_accessible ? [local.activemq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow ActiveMQ Web Console (HTTPS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Broker Port (AMQPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" ? [local.rabbitmq_ports.broker_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_broker_cidrs\n      description = \"Allow RabbitMQ AMQP (SSL/TLS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Management UI (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" && var.publicly_accessible ? [local.rabbitmq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow RabbitMQ Management UI (HTTPS)\"\n    }\n  }\n\n  # Default Egress Rule (Allow all outbound)\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n    description = \"Allow all outbound traffic\"\n  }\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_5", "ruleIndex": 17, "level": "error", "attachments": [], "message": {"text": "Ensure that Security Groups are attached to another resource"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 41, "endLine": 65, "snippet": {"text": "resource \"aws_security_group\" \"this\" {\n  for_each    = var.security_group_ids == null ? var.instances : {}\n  name        = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  description = \"Security group for ${each.key} RDS instance\"\n  vpc_id      = var.vpc_id\n\n  ingress {\n    # Dynamically look up the port based on the instance's engine type\n    from_port   = lookup(local.engine_ports, each.value.engine, 0)\n    to_port     = lookup(local.engine_ports, each.value.engine, 0)\n    protocol    = \"tcp\"\n    cidr_blocks = each.value.allowed_cidr_blocks\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = merge(var.tags, {\n    Name = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  })\n}\n"}}}}]}, {"ruleId": "CKV2_AWS_61", "ruleIndex": 18, "level": "error", "attachments": [], "message": {"text": "Ensure that an S3 bucket has a lifecycle configuration"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 14, "endLine": 17, "snippet": {"text": "resource \"aws_s3_bucket\" \"this\" {\n  bucket = \"${var.project_name}-${var.bucket_name}-${var.environment}-s3\"\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CKV_AWS_144", "ruleIndex": 19, "level": "error", "attachments": [], "message": {"text": "Ensure that S3 bucket has cross-region replication enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 14, "endLine": 17, "snippet": {"text": "resource \"aws_s3_bucket\" \"this\" {\n  bucket = \"${var.project_name}-${var.bucket_name}-${var.environment}-s3\"\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CKV_AWS_18", "ruleIndex": 20, "level": "error", "attachments": [], "message": {"text": "Ensure the S3 bucket has access logging enabled"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/s3/main.tf"}, "region": {"startLine": 14, "endLine": 17, "snippet": {"text": "resource \"aws_s3_bucket\" \"this\" {\n  bucket = \"${var.project_name}-${var.bucket_name}-${var.environment}-s3\"\n  tags = local.common_tags\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 41, "endLine": 51, "snippet": {"text": "resource \"aws_secretsmanager_secret\" \"mq_broker_password_secret\" {\n  name                    = local.secret_name\n  description             = \"${var.secret_description} for ${var.broker_name}\"\n  kms_key_id              = var.secret_kms_key_id\n  recovery_window_in_days = var.secret_recovery_window_in_days\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 58, "endLine": 114, "snippet": {"text": "resource \"aws_security_group\" \"mq_broker_sg\" {\n  count = var.create_security_group ? 1 : 0\n\n  name        = \"${var.broker_name}-sg\"\n  description = \"Security group for MQ broker ${var.broker_name}\"\n  vpc_id      = var.vpc_id\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n\n  # Ingress rules for ActiveMQ Web Console (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"ActiveMQ\" && var.publicly_accessible ? [local.activemq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow ActiveMQ Web Console (HTTPS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Broker Port (AMQPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" ? [local.rabbitmq_ports.broker_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_broker_cidrs\n      description = \"Allow RabbitMQ AMQP (SSL/TLS)\"\n    }\n  }\n\n  # Ingress rules for RabbitMQ Management UI (HTTPS)\n  dynamic \"ingress\" {\n    for_each = var.create_security_group && var.engine_type == \"RabbitMQ\" && var.publicly_accessible ? [local.rabbitmq_ports.web_ssl] : []\n    content {\n      protocol    = \"tcp\"\n      from_port   = ingress.value\n      to_port     = ingress.value\n      cidr_blocks = var.sg_allowed_admin_cidrs\n      description = \"Allow RabbitMQ Management UI (HTTPS)\"\n    }\n  }\n\n  # Default Egress Rule (Allow all outbound)\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n    description = \"Allow all outbound traffic\"\n  }\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/aws_mq_broker/main.tf"}, "region": {"startLine": 116, "endLine": 158, "snippet": {"text": "resource \"aws_mq_broker\" \"mq_broker\" {\n  broker_name                = var.broker_name\n  engine_type                = var.engine_type\n  engine_version             = var.engine_version\n  host_instance_type         = var.host_instance_type\n  deployment_mode            = var.deployment_mode\n  publicly_accessible        = var.publicly_accessible\n  auto_minor_version_upgrade = var.auto_minor_version_upgrade\n\n  # User credentials for the broker\n  user {\n    username = var.broker_username\n    password = local.final_broker_password\n  }\n\n  subnet_ids = var.subnet_ids\n  security_groups = local.final_security_group_ids\n\n\n  # Maintenance window start time (UTC)\n  maintenance_window_start_time {\n    day_of_week = var.maintenance_day_of_week # e.g., MONDAY\n    time_of_day = var.maintenance_time_of_day # e.g., 03:00\n    time_zone   = var.maintenance_time_zone   # e.g., UTC\n  }\n\n  # Enable CloudWatch Logs. Options: \"AUDIT\", \"GENERAL\"\n  logs {\n    general = var.enable_general_logs\n    audit   = var.enable_audit_logs\n  }\n\n  apply_immediately = var.apply_immediately\n\n  tags = merge(\n    local.common_tags,\n    var.additional_tags\n  )\n  \n  lifecycle {\n    ignore_changes = [engine_version]\n  }\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 6, "endLine": 15, "snippet": {"text": "resource \"aws_db_subnet_group\" \"this\" {\n  count = var.db_subnet_group_name == null ? 1 : 0\n  # You can create a more dynamic name if you wish\n  name       = \"${var.project_name}-${var.environment}-db-subnet-group\"\n  subnet_ids = var.subnet_ids\n\n  tags = merge(var.tags, {\n    Name = \"${var.project_name}-${var.environment}-db-subnet-group\"\n  })\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 29, "endLine": 33, "snippet": {"text": "resource \"aws_secretsmanager_secret\" \"rds_password\" {\n  for_each   = random_password.rds\n  name       = \"${each.key}-rds-password\"\n  description = \"RDS master password for ${each.key}\"\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 41, "endLine": 65, "snippet": {"text": "resource \"aws_security_group\" \"this\" {\n  for_each    = var.security_group_ids == null ? var.instances : {}\n  name        = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  description = \"Security group for ${each.key} RDS instance\"\n  vpc_id      = var.vpc_id\n\n  ingress {\n    # Dynamically look up the port based on the instance's engine type\n    from_port   = lookup(local.engine_ports, each.value.engine, 0)\n    to_port     = lookup(local.engine_ports, each.value.engine, 0)\n    protocol    = \"tcp\"\n    cidr_blocks = each.value.allowed_cidr_blocks\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = \"-1\"\n    cidr_blocks = [\"0.0.0.0/0\"]\n  }\n\n  tags = merge(var.tags, {\n    Name = \"${var.project_name}-${var.environment}-${each.key}-rds-sg\"\n  })\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 68, "endLine": 112, "snippet": {"text": "resource \"aws_db_instance\" \"managed_password\" {\n  for_each = { for k, v in var.instances : k => v if v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = lookup(each.value, \"final_snapshot_identifier\", null)\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  manage_master_user_password = true\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n\n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  tags = merge(var.tags, {\n    Name = each.value.name\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/rds/main.tf"}, "region": {"startLine": 114, "endLine": 165, "snippet": {"text": "resource \"aws_db_instance\" \"custom_password\" {\n  for_each = { for k, v in var.instances : k => v if !v.manage_master_user_password }\n\n  allocated_storage           = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.allocated_storage : null\n  backup_retention_period     = each.value.backup_retention_period\n  backup_window               = each.value.backup_window\n  db_name                     = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_name : null\n  db_subnet_group_name        = var.db_subnet_group_name != null ? data.aws_db_subnet_group.existing[0].name : aws_db_subnet_group.this[0].name\n  deletion_protection         = each.value.deletion_protection\n  engine                      = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine : null\n  engine_version              = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.engine_version : null\n  final_snapshot_identifier   = each.value.skip_final_snapshot ? null : \"${each.key}-final-snapshot\"\n  identifier                  = each.value.name\n  instance_class              = each.value.instance_class\n  kms_key_id                  = var.kms_key_arn != null ? var.kms_key_arn : null\n  maintenance_window          = each.value.maintenance_window\n  password                    = aws_secretsmanager_secret_version.rds_password[each.key].secret_string\n  multi_az                    = each.value.multi_az\n  snapshot_identifier         = lookup(each.value, \"snapshot_identifier\", null)\n  storage_type                = each.value.storage_type\n  storage_encrypted           = each.value.storage_encrypted\n  skip_final_snapshot         = each.value.skip_final_snapshot\n  username                    = lookup(each.value, \"snapshot_identifier\", null) == null ? each.value.database_user : null\n  enabled_cloudwatch_logs_exports = lookup(each.value, \"enabled_cloudwatch_logs_exports\", [])\n  \n  vpc_security_group_ids = concat(\n    [\n      var.security_group_ids != null ?\n      data.aws_security_group.existing[each.key].id :\n      aws_security_group.this[each.key].id\n    ],\n    var.vpc_security_group_ids\n  )\n\n  lifecycle {\n    precondition {\n      condition     = var.secret_name == null\n      error_message = \"The secret_name must be not be provided as a parameter if manage_master_user_password is false.\"\n    }\n  }\n\n  tags = merge(var.tags, {\n    Name = each.value.name,\n    source-repo = var.source-repo\n  })\n\n  timeouts {\n    create = \"90m\"\n    update = \"90m\"\n    delete = \"90m\"\n  }\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/runner-iam/main.tf"}, "region": {"startLine": 29, "endLine": 37, "snippet": {"text": "resource \"aws_iam_role\" \"this\" {\n  name               = var.role_name\n  assume_role_policy = data.aws_iam_policy_document.eks_trust_policy.json\n\n  tags = merge(var.tags, {\n    Name = var.role_name\n    source-repo = var.source-repo\n  })\n}\n"}}}}]}, {"ruleId": "CCL_COSMOS_FINOPS_TAGS", "ruleIndex": 21, "level": "error", "attachments": [], "message": {"text": "Ensure resources have required tag associated for Costing"}, "locations": [{"physicalLocation": {"artifactLocation": {"uri": "modules/runner-iam/main.tf"}, "region": {"startLine": 40, "endLine": 46, "snippet": {"text": "resource \"aws_eks_pod_identity_association\" \"this\" {\n  depends_on      = [aws_iam_role.this]\n  cluster_name    = var.cluster_name\n  namespace       = var.namespace\n  service_account = var.role_name\n  role_arn        = aws_iam_role.this.arn\n}\n"}}}}]}]}]}